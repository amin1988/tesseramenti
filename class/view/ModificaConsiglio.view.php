<?phpif (!defined("_BASE_DIR_"))    exit();include_controller('Consiglio');include_model('Tesserato', 'Consiglio', 'Polizza');include_view('NuovoTessPop');include_formview('FormView');class ModificaConsiglio extends ViewWithForm{    private $popup;    private $ctrl;    private $pulsanti;    private $idSoc;    private $idpresidente; // id presidente si trova anche nella tabella tesserati    function __construct($idsoc, $callback = NULL, $pulsanti = true)    {        $this->ctrl = new ConsiglioCtrl($idsoc, true, $callback);        if ($pulsanti)            $this->ctrl->getForm()->addSubmit('Aggiorna consiglio');        $this->form = new FormView($this->ctrl->getForm());        $POST_polizza = empty($_POST['polizze_assicurative']) ? NULL : $_POST['polizze_assicurative'];        $this->poliz = new Polizza('polizze_stipulate');        $this->idSoc = $idsoc;        $this->idpresidente = $this->ctrl->getConsiglio()->getPresidente();        $this->pulsanti = $pulsanti;        $this->popup = new NuovoTessPop($idsoc, NULL);    }    public function getSubview()    {        return array($this->form, $this->popup);    }    function stampa()    {        $this->popup->stampa();        /* @var $cons Consiglio */        $cons = $this->ctrl->getConsiglio();        $fv = $this->form;        if ($this->ctrl->haErrori())        {            echo '<div class="alert alert-error text-center"><strong>Errore:</strong> ';            echo $this->ctrl->getErrori();            echo '</div>';        }        $fv->stampaInizioForm();        echo '<div class="controls obbligatorio text-center">* Campi obbligatori</div><div class="row">';        echo '<div class="form-horizontal"><div class="span6">';        foreach (Consiglio::getRuoli() as $ruolo)        {            if ($ruolo != Consiglio::DIRETTORETECNICO)                $this->stampaRuolo($ruolo, $fv);        }        echo '</div><div class="span6">';        $this->stampaRuolo(Consiglio::DIRETTORETECNICO, $fv);        $obj_polizza = Polizza::elenco();        $nome_polizza = $obj_polizza[3]->getNomePolizza();        $polizza = new Polizza('polizze_stipulate');        $array_dati_polizza = array("id_polizza" => 3, "idtesserato" => $this->idpresidente, "idsocieta" => $this->idSoc, "data_stipula" => date("d-m-Y"), "data_da" => NULL, "data_a" => NULL, "tipo_polizza" => "3");        $polizza->setDati($array_dati_polizza);        $num_rows = $polizza->SearchRow();        $checked = "";        if ($num_rows > 0)        {            $checked = "checked";        }         $array_dati_polizza =  $polizza->getPolizza(1);         $polizza->setDati($array_dati_polizza);         if ( !empty($array_dati_polizza))                $polizza_scaduto = $polizza->polizzaScaduto();           else{               $polizza->setDati($array_dati_polizza);               $polizza_scaduto = true;           }        if (!$polizza_scaduto)        {            print '<div class="controls">' . $nome_polizza . '</div>';        } else            print '  <div class="controls"> <input type="checkbox"  ' . $checked . ' name="polizze_assicurative" value="3"/> ' . $nome_polizza . ' </div>';                echo "</div></div></div>";        if ($this->pulsanti)        {            echo '<div class="form-actions text-right">';            $fv->stampaSubmit(array('class' => 'btn-primary'));            echo '</div>';        }        if ($this->pulsanti)            $fv->stampaFineForm();    }    /**     *      * @param int $ruolo     * @param FormView $fv     */    private function stampaRuolo($ruolo, $fv)    {        $nr = $this->ctrl->getNomeRuolo($ruolo);        $el = $fv->getElem($ruolo);        $obblig = $el->getFormElem()->isObbligatorio();        echo "<div class=\"control-group";        if ($this->ctrl->haErrori($ruolo))            echo ' error';        echo "\">\n";        echo '<label class="control-label';        if ($obblig)            echo ' obbligatorio';        echo '">';        if ($obblig)            echo '* ';        echo "$nr</label>\n";        ?>        <div class="controls form-inline"><?php $el->stampa(NULL); ?>          <button class="btn btn-mini" type="button" onclick="nuovoTesseratoPop.mostra('<?php echo $ruolo; ?>')"><i class="icon-plus"></i></button>        </div>        <?php        echo "</div>";    }}