<?php
if (!defined('_BASE_DIR_')) exit();
include_controller('DettagliTesserato');
include_class('Sesso');
include_model('Provincia','Settore');
include_view('QualificaView');

class DettagliTesserato {
	
	private $ctrl;
	private $mostraSoc;
	
	function __construct($id_tes, $id_soc=NULL) {
		$this->ctrl = new DettagliTesseratoCtrl($id_tes, $id_soc);
		$this->mostraSoc = ($id_soc === NULL);
	} 
	
	public function getIdSocieta() {
		return $this->ctrl->getTesserato()->getIDSocieta();
	}
	
	public function stampaCss() {
		echo ".crediti {\n\tfont-style: italic;\n\tfont-weight: normal;\n}\n";
	}
	
	/**
	 * @param Tesserato $tes
	 */
	private function stampaIndirizzo($tes) {
		echo $tes->getIndirizzo();
		
		$cap = $tes->getCap();
		if ($cap != '') echo ", $cap";
		
		$citta = $tes->getCittaRes();
		
		$pr = Provincia::fromId($tes->getIDProvinciaRes());
		if ($pr !== NULL && $citta == '')
			$citta = $pr->getNome(); 
		if ($citta != '') echo ", $citta";
		if ($pr !== NULL) echo ' ('.$pr->getSigla().')';
	}
	
	private function stampaQualifiche() {
		$sl = array();
		$nomi = array();
		foreach ($this->ctrl->getQualifiche() as $q) {
			$sett = $this->ctrl->getSettore($q);
			$sl[$sett->getId()][] = $q;
			$nomi[$sett->getId()] = $sett->getNome();
		}
		foreach ($sl as $ids => $ql) {
			echo '<div class="row-fluid"><div class="offset4 span8"><h4>';
			echo "Qualifiche $nomi[$ids]</h4></div></div>\n";
			$crediti = $this->ctrl->getTotCrediti($ids);
			if ($crediti !== NULL) {
				$this->stampaRigaCrediti($crediti, true, $this->mostraSoc, $ids);
				echo "<div class=\"row-fluid crediti-dett\" id=\"crediti-dett-$ids\" style=\"display:none;\">";
				echo '  <div class="offset4 span8"><table class="table table-condensed table-striped">';
				foreach ($this->ctrl->getListaCrediti($ids) as $c) {
					$data = $c->getDataAss()->toDMY();
					$desc = $c->getDescrizione();
					$num = $c->getCrediti();
					echo "<tr><td>$data</td><td>$desc</td><td>$num</td></tr>\n";
				}
				echo '</table></div></div>';
			} elseif($this->mostraSoc) {
				$this->stampaRigaCrediti(0, false, true, $ids);
			}
			$this->stampaQualificheTipo($ql);
		}
	}
	
	private function stampaRigaCrediti($crediti, $lista, $mod, $idsett) {
		echo '<div class="row-fluid">';
		echo '  <div class="offset4 span8">';
		if ($lista) {
			echo "\n  <button type=\"button\" class=\"btn btn-small btn-crediti\" data-id=\"$idsett\">";
			echo "<i class=\"icon-list-alt\"></i></button>";
		}
		echo "\n  <span class=\"crediti\">Crediti:</span> $crediti ";
		if ($mod) {
			$t = $this->ctrl->getTesserato();
			$url = _PATH_ROOT_."segr/soc/crediti.php?soc=".$t->getIDSocieta()."&id=";
			$url .= $t->getId()."&set=$idsett";
			//TODO generalizzare url
			echo "\n  <a class=\"btn btn-small\" href=\"$url\"><i class=\"icon-pencil\"></i> Modifica</a>";
		}
		echo '</div>';
	}
	
	/**
	 * @param Qualifica[] $ql
	 */
	function stampaQualificheTipo($ql) {
		foreach ($ql as $qualifica)
		{
			$idtipo = $qualifica->getIdTipo();
			$tipo = $this->ctrl->getTipo($qualifica)->getNome();
			$grado = QualificaViewUtil::get()->getNome($qualifica);
			
			if (!$this->ctrl->isQualificaRinnovata($idtipo))
				$tipo = '<i class="icon-exclamation-sign" title="Qualifica non rinnovata"></i> '.$tipo;
			echo '<div class="row-fluid">';
			echo "  <div class=\"span4 tab-label\">$tipo</div>\n";
			echo "  <div class=\"span8\">$grado</div>\n";
			echo '</div>';
			
		}
	}
	
	function stampa()
	{
		$tes = $this->ctrl->getTesserato();
		
		if ($this->mostraSoc) {
			include_model('Societa');
			$soc = new Societa($tes->getIDSocieta());
		?> 
<div class="row-fluid">
  <div class="span4 tab-label">Societ&agrave;</div>
  <div class="span8"><?php echo $soc->getNome(); ?></div>
</div>
		<?php } //if mostraSoc ?>
<div class="row-fluid">
  <div class="span4 tab-label">NÂ° Tessera</div>
  <div class="span8"><?php echo $tes->getNumTessera() ; ?></div>
</div>
<div class="row-fluid">
  <div class="span4 tab-label">Cognome</div>
  <div class="span8"><?php echo $tes->getCognome(); ?></div>
</div>
<div class="row-fluid">
  <div class="span4 tab-label">Nome</div>
  <div class="span8"><?php echo $tes->getNome(); ?></div>
</div>
<div class="row-fluid">
  <div class="span4 tab-label">Sesso</div>
  <div class="span8"><?php echo Sesso::toStringLungo($tes->getSesso()); ?></div>
</div>
<div class="row-fluid">
  <div class="span4 tab-label">Data di nascita</div>
  <div class="span8"><?php echo $this->ctrl->getDataNascita();  ?></div>
</div>
<div class="row-fluid">
  <div class="span4 tab-label">Luogo di nascita</div>
  <div class="span8"><?php echo $this->ctrl->getLuogoNascita(); ?></div>
</div>
<div class="row-fluid">
  <div class="span4 tab-label">Codice Fiscale</div>
  <div class="span8"><?php echo $tes->getCodiceFiscale(); ?></div>
</div>
<div class="row-fluid">
  <div class="span4 tab-label">Indirizzo</div>
  <div class="span8"><?php echo $this->stampaIndirizzo($tes); ?></div>
</div>
<div class="row-fluid">
  <div class="span4 tab-label">Telefono</div>
  <div class="span8"><?php echo $tes->getTelefono(); ?></div>
</div>
<div class="row-fluid">
  <div class="span4 tab-label">Cellulare</div>
  <div class="span8"><?php echo $tes->getCellulare(); ?></div>
</div>
<div class="row-fluid">
  <div class="span4 tab-label">Email</div>
  <div class="span8"><?php echo $tes->getEmail(); ?></div>
</div>
<div class="row-fluid">
  <div class="span4 tab-label">Cittadinanza</div>
  <div class="span8"><?php echo $tes->getCittadinanza(); ?></div>
</div>
<?php 
		$this->stampaQualifiche();
	} //function stampa()
	
	public function stampaJsOnload() {
		?>
$('.btn-crediti').click(function() {
	var th = $(this);
	th.button('toggle');
	$('#crediti-dett-'+th.data('id')).toggle();
});
		<?php
	}
}
